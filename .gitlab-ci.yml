# GitLab CI/CD Pipeline for Languager Bot

stages:
  - test
  - build
  - deploy

variables:
  # Docker image and registry
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG_LATEST: $CI_REGISTRY_IMAGE:latest
  DOCKER_TAG_COMMIT: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  
  # Go configuration
  GO_VERSION: "1.21"
  GOPATH: $CI_PROJECT_DIR/.go
  
# Run only for private branch
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "private"

# Cache Go modules for faster builds
cache:
  paths:
    - .go/pkg/mod/

##############################################
# STAGE 1: TEST
##############################################

test:
  stage: test
  image: golang:${GO_VERSION}-alpine
  tags:
    - runner
  before_script:
    - apk add --no-cache git make gcc musl-dev
    - go version
  script:
    - echo "Running tests..."
    - go mod download
    - go test ./... -v -race -coverprofile=coverage.out
    - go tool cover -func=coverage.out | tail -1
    # Check minimum coverage (80%)
    - |
      coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
      echo "Total coverage: ${coverage}%"
      if [ $(echo "$coverage < 80" | bc -l) -eq 1 ]; then
        echo "Coverage ${coverage}% is below minimum 80%"
        exit 1
      fi
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    paths:
      - coverage.out
    expire_in: 30 days

##############################################
# STAGE 2: BUILD & PUSH
##############################################

build:
  stage: build
  image: docker:24-git
  services:
    - docker:24-dind
  tags:
    - runner
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $DOCKER_TAG_COMMIT -t $DOCKER_TAG_LATEST .
    - echo "Pushing to GitLab Container Registry..."
    - docker push $DOCKER_TAG_COMMIT
    - docker push $DOCKER_TAG_LATEST
    - echo "Image pushed: $DOCKER_TAG_COMMIT"
  only:
    - private

##############################################
# STAGE 3: DEPLOY
##############################################

deploy:
  stage: deploy
  image: alpine:latest
  tags:
    - runner
  before_script:
    # Install SSH and other tools
    - apk add --no-cache openssh-client bash
    # Setup SSH
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to server $SERVER_HOST..."
    - echo "Deploy path: $DEPLOY_PATH"
    
    # Copy deployment scripts to server
    - scp scripts/deploy.sh ${SERVER_USER}@${SERVER_HOST}:${DEPLOY_PATH}/
    - scp scripts/health_check.sh ${SERVER_USER}@${SERVER_HOST}:${DEPLOY_PATH}/
    
    # Execute deployment on server
    - |
      ssh ${SERVER_USER}@${SERVER_HOST} "
        cd /opt/LanguagerEN2 || exit 1
        echo 'Current directory:' \$(pwd)
        chmod +x deploy.sh health_check.sh
        export DOCKER_IMAGE=${DOCKER_TAG_COMMIT}
        export CI_REGISTRY=${CI_REGISTRY}
        export CI_REGISTRY_USER=${CI_REGISTRY_USER}
        export CI_REGISTRY_PASSWORD=${CI_REGISTRY_PASSWORD}
        ./deploy.sh
      "
  environment:
    name: production
    url: https://t.me/your_bot_username
  only:
    - private
  when: manual  # Require manual approval for deploy

