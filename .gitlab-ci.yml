# GitLab CI/CD Pipeline for Languager Bot

stages:
  - test
  - build
  - deploy

variables:
  # Docker image and registry
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG_LATEST: $CI_REGISTRY_IMAGE:latest
  DOCKER_TAG_COMMIT: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  
  # Go configuration
  GO_VERSION: "1.21"
  
# Run only for private branch
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "private"

##############################################
# STAGE 1: TEST
##############################################

test:
  stage: test
  tags:
    - runner
  before_script:
    # Clean up old Go modules if they exist
    - rm -rf .go || true
    - go version
  script:
    - echo "Running tests..."
    - go mod download
    - go test ./... -v -race -coverprofile=coverage.out
    - go tool cover -func=coverage.out | tail -1
    # Check minimum coverage (25%)
    - |
      coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
      echo "Total coverage: ${coverage}%"
      if [ $(echo "$coverage < 25" | bc -l) -eq 1 ]; then
        echo "Coverage ${coverage}% is below minimum 25%"
        exit 1
      fi
  after_script:
    # Clean up Go modules with proper permissions
    - chmod -R u+w .go 2>/dev/null || true
    - rm -rf .go || true
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    paths:
      - coverage.out
    expire_in: 30 days

##############################################
# STAGE 2: BUILD & PUSH
##############################################

build:
  stage: build
  tags:
    - runner
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $DOCKER_TAG_COMMIT -t $DOCKER_TAG_LATEST .
    - echo "Pushing to GitLab Container Registry..."
    - docker push $DOCKER_TAG_COMMIT
    - docker push $DOCKER_TAG_LATEST
    - echo 'Image pushed:' $DOCKER_TAG_COMMIT


##############################################
# STAGE 3: DEPLOY
##############################################

deploy:
  stage: deploy
  only:
    - private
  tags:
    - runner
  script:
    - cd /opt/LanguagerEN2
    - echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ PROD Ð±Ð¾Ñ‚Ð°..."
    - git pull
    - docker compose down || true
    - docker compose up -d --build
    - echo "GO"
  environment:
    name: production
    url: https://t.me/your_bot_username
  when: manual  # Require manual approval for deploy

